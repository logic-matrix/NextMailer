{% extends "base.html" %}
{% block title %}NextMailer - Uploads{% endblock %}

{% block content %}
<br><br><br>
<h2>Uploads</h2>
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
<!-- Upload Form -->
<form method="POST" enctype="multipart/form-data" action="/uploads">
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="name" class="form-label">Image Name</label>
            <input type="text" class="form-control" name="name" placeholder="Enter image name" required>
        </div>
        <div class="col-md-6">
            <label for="file" class="form-label">Select Image</label>
            <input type="file" class="form-control" name="file" accept="image/*" onchange="previewImage(event)"
                required>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Upload</button>
</form>

<hr>

<!-- Image Preview Section -->
<div id="preview-section" style="display:none; margin-top:20px;">
    <h4>Preview</h4>
    <img id="preview" src="" alt="Uploaded Image"
        style="max-width:300px; border:1px solid #ccc; padding:5px; border-radius:8px;">
    <br><br>
    <form method="POST" action="">
        <input type="hidden" name="delete_name" id="delete_name">
        <button type="submit" class="btn btn-danger">Delete</button>
    </form>
</div>
<!-- Image list-->
<h3 class="mt-5">Uploaded Images</h3>
<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Filepath</th>
            <th>Uploaded At</th>
            <th>Image</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for img in images %}
        <tr>
            <td>{{ img.id }}</td>
            <td>{{ img.filename }}</td>
            <td>{{ img.filepath }}</td>
            <td>{{ img.uploaded_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td><img src="{{ img.filepath }}" alt="{{ img.name }}" style="max-width:100px; max-height:100px;"></td>
            <td>
                <form method="POST" action="">
                    <input type="hidden" name="delete_name" value="{{ img.filename }}">
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
        </tr>
        {% endfor %}
    </tbody>
<script>
    function previewImage(event) {
        const preview = document.getElementById('preview');
        const previewSection = document.getElementById('preview-section');
        const fileInput = event.target;
        const deleteInput = document.getElementById('delete_name');

        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                previewSection.style.display = 'block';
                deleteInput.value = fileInput.files[0].name;
            }
            reader.readAsDataURL(fileInput.files[0]);
        }
    }
</script>

{% endblock %}